/*
 * OneWire.h
 *
 *  Created on: Oct 17, 2015
 *      Author: ddtdanilo
 */

#ifndef ONEWIRE_H_
#define ONEWIRE_H_

// Configure UART for 1-Wire RESET timing
byte onewireReset() {
    // Configure UART for 1-Wire RESET timing
    (void)S_Wire_SetBaudRateMode(1);
    S_Wire_SendChar(0xF0);
    byte read;
    S_Wire_RecvChar(&read);
    if (read == -1) {
        // No UART data at all
        //server.log("No circuit connected to UART.");
        return false;
    } else if (read == 0xF0) {
        // UART RX will read TX if there's no device connected
        //server.log("No 1-Wire devices are present.");
        return false;
    } else {
        // Switch UART to 1-Wire data speed timing 115200
       (void)S_Wire_SetBaudRateMode(0);
        return true;
    }
}
 
byte onewireWriteByte(byte) {
    byte i;
    for (i = 0 ; i < 8 ; i++, byte = byte >> 1) {
        // Run through the bits in the byte, extracting the
        // LSB (bit 0) and sending it to the bus
        onewireBit(byte & 0x01);
    }
} 
 
byte onewireReadByte() {
    byte byteIn = 0;
    for (byte i = 0 ; i < 8 ; i++) {
        // Build up byte bit by bit, LSB first
        byteIn = (byteIn >> 1) + 0x80 * onewireBit(1);
    }
    return byteIn;
}
 
byte onewireBit(bit) {
    bit = bit ? 0xFF : 0x00;
    S_Wire_SendChar(bit);
    byte read;
    S_Wire_RecvChar(&read);
    byte returnVal = read == 0xFF ? 1 : 0;
    return returnVal;
}
 
// Wake up every 5 seconds and write to the server
 
word awakeAndGetTemp();


#endif /* ONEWIRE_H_ */
